<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🦷 DentalERP - Test Sistema Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">🦷 DentalERP</h1>
            <p class="text-lg text-gray-600">Sistema de Citas con Email Automático</p>
            <div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full mt-4">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                Sistema 100% Funcional
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Panel de Crear Cita -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    📅 Crear Nueva Cita
                    <span class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">AUTO</span>
                </h2>
                
                <form id="citaForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            👤 Paciente
                        </label>
                        <select id="pacienteSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">🔄 Cargando pacientes...</option>
                        </select>
                        <div id="pacienteInfo" class="mt-2 p-2 bg-gray-50 rounded text-sm hidden">
                            <span id="pacienteEmail" class="text-gray-600"></span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            👨‍⚕️ Dentista
                        </label>
                        <select id="dentistaSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">🔄 Cargando dentistas...</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                📅 Fecha
                            </label>
                            <input type="date" id="fechaCita" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ⏰ Hora
                            </label>
                            <select id="horaCita" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Seleccionar hora</option>
                                <option value="08:00">08:00 AM</option>
                                <option value="09:00">09:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">01:00 PM</option>
                                <option value="14:00">02:00 PM</option>
                                <option value="15:00">03:00 PM</option>
                                <option value="16:00">04:00 PM</option>
                                <option value="17:00">05:00 PM</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            🏥 Tipo de Cita
                        </label>
                        <select id="tipoCita" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="consulta">Consulta General</option>
                            <option value="tratamiento">Tratamiento</option>
                            <option value="seguimiento">Seguimiento</option>
                            <option value="limpieza">Limpieza Dental</option>
                            <option value="revision">Revisión</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            📝 Motivo de Consulta
                        </label>
                        <textarea id="motivoConsulta" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Describe el motivo de la cita..."></textarea>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-primary to-secondary text-white font-bold py-3 px-6 rounded-lg hover:shadow-lg transition-all duration-200 flex items-center justify-center">
                        <span id="submitText">📅 Crear Cita y Enviar Email</span>
                        <div id="submitLoader" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </button>
                </form>

                <!-- Información del Sistema -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">✨ Funcionalidades Automáticas</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>✅ Confirmación automática de la cita</li>
                        <li>✅ Envío automático de email de confirmación</li>
                        <li>✅ Generación automática de número de cita</li>
                        <li>✅ Validación de horarios y conflictos</li>
                    </ul>
                </div>
            </div>

            <!-- Panel de Resultados -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">📊 Resultados del Sistema</h2>
                
                <!-- Status de APIs -->
                <div class="space-y-4 mb-6">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">🔌 Backend API</span>
                        <span id="backendStatus" class="px-2 py-1 text-xs font-semibold rounded-full">🔄 Verificando...</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">👥 Pacientes</span>
                        <span id="pacientesStatus" class="px-2 py-1 text-xs font-semibold rounded-full">🔄 Cargando...</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium">👨‍⚕️ Dentistas</span>
                        <span id="dentistasStatus" class="px-2 py-1 text-xs font-semibold rounded-full">🔄 Cargando...</span>
                    </div>
                </div>

                <!-- Resultado de Creación -->
                <div id="resultado" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">🎉 Cita Creada Exitosamente</h3>
                    <div id="citaDetails" class="bg-green-50 border border-green-200 rounded-lg p-4 space-y-2">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>

                <!-- Log de Actividades -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">📝 Log del Sistema</h3>
                    <div id="logContainer" class="bg-gray-900 text-green-400 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm">
                        <div class="text-white">🚀 DentalERP System Log - Iniciado</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001/api';
        let pacientesData = [];
        let dentistasData = [];

        // Función para agregar log
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            logContainer.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Función para actualizar status
        function updateStatus(elementId, status, success = true) {
            const element = document.getElementById(elementId);
            if (success) {
                element.className = 'px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800';
                element.textContent = `✅ ${status}`;
            } else {
                element.className = 'px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800';
                element.textContent = `❌ ${status}`;
            }
        }

        // Verificar conexión con backend
        async function checkBackend() {
            try {
                const response = await fetch(`${API_BASE}/citas/`);
                if (response.ok) {
                    updateStatus('backendStatus', 'Conectado');
                    addLog('✅ Conexión con backend establecida', 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('backendStatus', 'Error', false);
                addLog(`❌ Error conectando con backend: ${error.message}`, 'error');
                return false;
            }
        }

        // Cargar pacientes
        async function loadPacientes() {
            try {
                addLog('🔄 Cargando lista de pacientes...');
                const response = await fetch(`${API_BASE}/citas/pacientes_disponibles/`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                pacientesData = data.pacientes;
                
                const select = document.getElementById('pacienteSelect');
                select.innerHTML = '<option value="">Seleccionar paciente...</option>';
                
                pacientesData.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = paciente.info_display;
                    option.dataset.email = paciente.email;
                    option.dataset.tieneEmail = paciente.tiene_email;
                    select.appendChild(option);
                });
                
                updateStatus('pacientesStatus', `${data.count} disponibles`);
                addLog(`✅ ${data.count} pacientes cargados correctamente`, 'success');
                
            } catch (error) {
                updateStatus('pacientesStatus', 'Error', false);
                addLog(`❌ Error cargando pacientes: ${error.message}`, 'error');
            }
        }

        // Cargar dentistas
        async function loadDentistas() {
            try {
                addLog('🔄 Cargando lista de dentistas...');
                const response = await fetch(`${API_BASE}/dentistas/`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                dentistasData = data;
                
                const select = document.getElementById('dentistaSelect');
                select.innerHTML = '<option value="">Seleccionar dentista...</option>';
                
                data.forEach(dentista => {
                    const option = document.createElement('option');
                    option.value = dentista.id;
                    option.textContent = dentista.nombre_completo;
                    select.appendChild(option);
                });
                
                updateStatus('dentistasStatus', `${data.length} disponibles`);
                addLog(`✅ ${data.length} dentistas cargados correctamente`, 'success');
                
            } catch (error) {
                updateStatus('dentistasStatus', 'Error', false);
                addLog(`❌ Error cargando dentistas: ${error.message}`, 'error');
            }
        }

        // Manejar selección de paciente
        document.getElementById('pacienteSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const infoDiv = document.getElementById('pacienteInfo');
            const emailSpan = document.getElementById('pacienteEmail');
            
            if (selectedOption.value) {
                const tieneEmail = selectedOption.dataset.tieneEmail === 'true';
                emailSpan.textContent = tieneEmail ? 
                    `📧 ${selectedOption.dataset.email} (Email automático activado)` : 
                    '⚠️ Sin email - No se enviará confirmación automática';
                emailSpan.className = tieneEmail ? 'text-green-600' : 'text-amber-600';
                infoDiv.classList.remove('hidden');
            } else {
                infoDiv.classList.add('hidden');
            }
        });

        // Manejar envío del formulario
        document.getElementById('citaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitLoader = document.getElementById('submitLoader');
            
            // Mostrar loading
            submitBtn.disabled = true;
            submitText.classList.add('hidden');
            submitLoader.classList.remove('hidden');
            
            try {
                const formData = {
                    paciente: document.getElementById('pacienteSelect').value,
                    dentista: document.getElementById('dentistaSelect').value,
                    fecha_hora: `${document.getElementById('fechaCita').value}T${document.getElementById('horaCita').value}`,
                    tipo_cita: document.getElementById('tipoCita').value,
                    motivo_consulta: document.getElementById('motivoConsulta').value || 'Consulta general'
                };
                
                addLog('🔄 Creando nueva cita...', 'info');
                addLog(`📝 Datos: ${JSON.stringify(formData, null, 2)}`, 'info');
                
                const response = await fetch(`${API_BASE}/citas/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                // Mostrar resultado
                document.getElementById('resultado').classList.remove('hidden');
                const detailsDiv = document.getElementById('citaDetails');
                detailsDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>📋 Número:</strong> ${result.numero_cita}</div>
                        <div><strong>📅 Estado:</strong> <span class="text-green-600">${result.estado}</span></div>
                        <div><strong>👤 Paciente:</strong> ${result.paciente_nombre}</div>
                        <div><strong>👨‍⚕️ Dentista:</strong> ${result.dentista_nombre}</div>
                        <div><strong>📅 Fecha:</strong> ${result.fecha_formateada}</div>
                        <div><strong>⏱️ Duración:</strong> ${result.duracion_formateada}</div>
                        <div class="col-span-2"><strong>📧 Email:</strong> 
                            <span class="${result.email_enviado ? 'text-green-600' : 'text-amber-600'}">
                                ${result.email_enviado ? '✅ Enviado automáticamente' : '⚠️ No enviado'}
                            </span>
                        </div>
                    </div>
                `;
                
                addLog(`🎉 Cita creada exitosamente: ${result.numero_cita}`, 'success');
                addLog(`📧 Email ${result.email_enviado ? 'enviado' : 'no enviado'}: ${result.paciente_nombre}`, result.email_enviado ? 'success' : 'info');
                
                // Limpiar formulario
                document.getElementById('citaForm').reset();
                document.getElementById('pacienteInfo').classList.add('hidden');
                
            } catch (error) {
                addLog(`❌ Error creando cita: ${error.message}`, 'error');
            } finally {
                // Ocultar loading
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoader.classList.add('hidden');
            }
        });

        // Inicializar sistema
        async function init() {
            addLog('🚀 Iniciando sistema DentalERP...', 'info');
            
            // Configurar fecha mínima (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaCita').min = today;
            document.getElementById('fechaCita').value = today;
            
            // Verificar backend y cargar datos
            const backendOk = await checkBackend();
            if (backendOk) {
                await Promise.all([loadPacientes(), loadDentistas()]);
                addLog('✅ Sistema completamente inicializado', 'success');
            }
        }

        // Iniciar cuando la página cargue
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
